<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>环球寻光记 - 国内畅游</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "e754181c0557bd50f114e8944c9100bf"
        };
    </script>
    <script src="https://webapi.amap.com/loader.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
        }
        .place-selector {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: calc(100vh - 140px);
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
        }
        .search-section {
            margin-bottom: 20px;
        }
        .poi-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }
        .poi-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .poi-item:hover {
            background-color: #f8f9fa;
        }
        .poi-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .map-wrapper {
            flex: 1;
            position: relative;
            height: calc(100vh - 140px);
        }
        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .page-title {
            padding: 20px;
            margin: 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            text-align: center;
            padding: 10px;
            color: #666;
        }
    </style>
</head>

<body>
    {% include 'navbar.html' %}

    <div class="page-container">
        <h2 class="page-title">国内畅游地图</h2>
        
        <div class="content-container">
            <!-- 左侧搜索和景点列表 -->
            <div class="place-selector">
                <div class="search-section">
                    <h3 class="h5 mb-3">搜索景点</h3>
                    <div class="mb-3">
                        <label for="placeSearch" class="form-label">选择景点</label>
                        <select class="form-select" id="placeSearch">
                            <option value="">请选择景点</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="searchPOI()">搜索内部景点</button>
                </div>
                
                <div class="poi-list" id="poiList">
                    <!-- 景点列表将在这里动态显示 -->
                </div>
            </div>
            
            <!-- 右侧地图 -->
            <div class="map-wrapper">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        let map;
        let placeSearch;
        let places = [];
        let selectedPOIs = new Set();
        let currentSearch = null;
        let poiCoordinates = new Map(); // 存储POI坐标信息

        // 页面加载时获取地点列表
        window.onload = function() {
            fetch('/get_places')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        places = data.places;
                        const placeSelect = document.getElementById('placeSearch');
                        
                        // 添加地点选项
                        places.forEach(place => {
                            placeSelect.add(new Option(place, place));
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        };

        // 初始化地图
        AMapLoader.load({
            key: "a4db26f20581ee86ee953a1e3ac1fbd1",
            version: "2.0",
            plugins: ['AMap.PlaceSearch']
        })
        .then((AMap) => {
            map = new AMap.Map('map', {
                resizeEnable: true,
                center: [116.397428, 39.90923],
                zoom: 13
            });

            // 初始化地点搜索
            placeSearch = new AMap.PlaceSearch({
                pageSize: 25,
                pageIndex: 1,
                city: "全国",
                citylimit: false,
                map: map,
                autoFitView: true,
                showCover: false,  // 不显示标记
                showMarker: false  // 不显示标记
            });
        })
        .catch((e) => {
            console.error(e);
        });

        function searchPage(keyword, page) {
            return new Promise((resolve, reject) => {
                try {
                    placeSearch.setPageIndex(page);
                    placeSearch.search(keyword, function(status, result) {
                        if (status === 'complete' && result && result.poiList && result.poiList.pois) {
                            resolve(result);
                        } else {
                            console.log(`搜索第${page}页失败:`, status, result);
                            resolve({ poiList: { pois: [] } }); // 返回空结果而不是reject
                        }
                    });
                } catch (error) {
                    console.error(`搜索第${page}页时发生错误:`, error);
                    resolve({ poiList: { pois: [] } }); // 返回空结果而不是reject
                }
            });
        }

        async function searchPOI() {
            const selectedPlace = document.getElementById('placeSearch').value;
            if (!selectedPlace) {
                alert('请先选择一个景点');
                return;
            }

            // 清空之前的搜索结果
            document.getElementById('poiList').innerHTML = '<div class="loading">正在搜索景点...</div>';
            selectedPOIs.clear();
            poiCoordinates.clear();
            map.clearMap();

            // 存储当前搜索的关键词
            currentSearch = selectedPlace;

            try {
                // 首先获取第一页结果，找到第一个点
                const firstPageResult = await searchPage(selectedPlace, 1);
                if (!firstPageResult || !firstPageResult.poiList || !firstPageResult.poiList.pois || firstPageResult.poiList.pois.length === 0) {
                    throw new Error('未找到景点');
                }

                const firstPOI = firstPageResult.poiList.pois[0];
                const firstLocation = firstPOI.location;
                const filteredPOIs = [firstPOI]; // 将第一个点加入结果集

                // 计算两点之间的距离（米）
                function calculateDistance(loc1, loc2) {
                    const R = 6371000; // 地球半径（米）
                    const lat1 = loc1.lat * Math.PI / 180;
                    const lat2 = loc2.lat * Math.PI / 180;
                    const deltaLat = (loc2.lat - loc1.lat) * Math.PI / 180;
                    const deltaLng = (loc2.lng - loc1.lng) * Math.PI / 180;

                    const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                            Math.cos(lat1) * Math.cos(lat2) *
                            Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }

                // 继续搜索更多页，直到找到100个点或没有更多结果
                let page = 1;
                let consecutiveEmptyPages = 0;
                const MAX_CONSECUTIVE_EMPTY = 2; // 连续空页面的最大数量

                while (filteredPOIs.length < 100 && consecutiveEmptyPages < MAX_CONSECUTIVE_EMPTY) {
                    page++;
                    const result = await searchPage(selectedPlace, page);
                    
                    if (!result || !result.poiList || !result.poiList.pois || result.poiList.pois.length === 0) {
                        consecutiveEmptyPages++;
                        continue;
                    }

                    consecutiveEmptyPages = 0; // 重置连续空页面计数

                    // 过滤3公里范围内的点
                    const newPOIs = result.poiList.pois.filter(poi => {
                        const distance = calculateDistance(firstLocation, poi.location);
                        return distance <= 3000; // 3公里 = 3000米
                    });

                    filteredPOIs.push(...newPOIs);
                    if (filteredPOIs.length >= 100) {
                        filteredPOIs.length = 100; // 只保留前100个点
                        break;
                    }
                }

                if (filteredPOIs.length === 0) {
                    throw new Error('未找到符合条件的景点');
                }

                // 生成图连接
                await createConnections(filteredPOIs);

                // 清除搜索数据，但保留图结构
                placeSearch.clear();
                
                // 显示所有搜索结果
                displayPOIs(filteredPOIs);
            } catch (error) {
                console.error('搜索失败:', error);
                document.getElementById('poiList').innerHTML = `<div class="loading">搜索失败: ${error.message}</div>`;
            }
        }

        function displayPOIs(pois) {
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '';

            if (pois.length === 0) {
                poiList.innerHTML = '<div class="loading">未找到相关景点</div>';
                return;
            }

            // 按距离排序
            pois.sort((a, b) => a.distance - b.distance);

            pois.forEach(poi => {
                // 存储POI的坐标信息
                poiCoordinates.set(poi.id, {
                    lng: poi.location.lng,
                    lat: poi.location.lat
                });

                const poiItem = document.createElement('div');
                poiItem.className = 'poi-item';
                poiItem.innerHTML = `
                    <h5 class="mb-1">${poi.name}</h5>
                    <p class="mb-1 small text-muted">${poi.address}</p>
                    <p class="mb-0 small">距离：${poi.distance}米</p>
                `;
                
                // 存储标记对象
                let marker = null;
                
                poiItem.onclick = function() {
                    this.classList.toggle('selected');
                    if (this.classList.contains('selected')) {
                        selectedPOIs.add(poi);
                        // 使用存储的坐标创建标记
                        const coordinates = poiCoordinates.get(poi.id);
                        if (coordinates) {
                            marker = new AMap.Marker({
                                position: [coordinates.lng, coordinates.lat],
                                title: poi.name,
                                map: map,
                                icon: new AMap.Icon({
                                    size: new AMap.Size(25, 34),
                                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                                    imageSize: new AMap.Size(25, 34)
                                }),
                                offset: new AMap.Pixel(-13, -30)
                            });
                        }
                    } else {
                        selectedPOIs.delete(poi);
                        // 移除地图上的标记
                        if (marker) {
                            map.remove(marker);
                            marker = null;
                        }
                    }
                };
                
                poiList.appendChild(poiItem);
            });
        }

        // 定义交通方式组合的颜色映射
        const TRANSPORT_COLORS = {
            '步行': '#FF3366',                           // 玫红色：仅步行
            '步行,骑行': '#33FF66',                      // 亮绿色：步行+骑行
            '步行,驾车': '#3399FF',                      // 天蓝色：步行+驾车
            '步行,骑行,驾车': '#FF9933'                  // 亮橙色：全部支持
        };

        // 获取交通方式的颜色
        function getTransportColor(modes) {
            if (!Array.isArray(modes)) {
                console.error('Invalid modes:', modes);
                return '#666666';
            }
            
            const sortedModes = [...modes].sort().join(',');
            return TRANSPORT_COLORS[sortedModes] || '#666666';
        }

        // 创建连线
        function createConnections(pois) {
            return new Promise((resolve, reject) => {
                console.log('Sending POIs to backend:', pois);
                
                // 发送搜索结果到后端
                fetch('/update_map_graph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pois: pois.map(poi => ({
                            id: poi.id,
                            location: {
                                lng: poi.location.lng,
                                lat: poi.location.lat
                            },
                            name: poi.name,
                            address: poi.address || ''
                        }))
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received connections from backend:', data);
                    
                    // 清除之前的连线
                    map.getAllOverlays('polyline').forEach(line => {
                        map.remove(line);
                    });
                    
                    // 绘制所有连线
                    if (data.edges) {
                        console.log('All edges:', data.edges);
                        data.edges.forEach(edge => {
                            console.log('Processing edge:', edge);
                            
                            // 检查点的位置信息是否存在
                            if (!edge.source || !edge.source.location || !edge.target || !edge.target.location) {
                                console.error('Invalid edge data:', edge);
                                return;
                            }

                            // 获取该连接支持的交通方式的颜色
                            const color = getTransportColor(edge.properties.modes);
                            console.log('Selected color for modes', edge.properties.modes, ':', color);
                            
                            // 创建连线
                            var line = new AMap.Polyline({
                                path: [
                                    [edge.source.location.lng, edge.source.location.lat],
                                    [edge.target.location.lng, edge.target.location.lat]
                                ],
                                strokeColor: color,
                                strokeOpacity: 0.8,
                                strokeWeight: 3,
                                strokeStyle: "solid",
                                lineJoin: 'round',
                                lineCap: 'round',
                                zIndex: 50,
                                // 添加鼠标悬停提示信息
                                extData: {
                                    modes: edge.properties.modes,
                                    weights: edge.properties.weights,
                                    from: edge.source.name,
                                    to: edge.target.name,
                                    distance: edge.properties.distance,
                                    congestion: edge.properties.congestion
                                }
                            });
                            
                            // 添加鼠标悬停事件
                            line.on('mouseover', function(e) {
                                const data = e.target.getExtData();
                                console.log('Hover data:', data);
                                const content = `
                                    <div style="padding: 10px;">
                                        <p><strong>从:</strong> ${data.from}</p>
                                        <p><strong>到:</strong> ${data.to}</p>
                                        <p><strong>距离:</strong> ${data.distance >= 1000 ? 
                                            (data.distance / 1000).toFixed(2) + ' 公里' : 
                                            Math.round(data.distance) + ' 米'}</p>
                                        <p><strong>拥挤度:</strong> ${data.congestion ? 
                                            (data.congestion * 100).toFixed(0) + '%' : 
                                            '未知'}</p>
                                        <p><strong>支持的交通方式:</strong></p>
                                        ${Object.entries(data.weights).map(([mode, weight]) => 
                                            `<p>${mode}: ${Math.round(weight)}分钟</p>`
                                        ).join('')}
                                    </div>
                                `;
                                
                                // 创建信息窗体
                                var infoWindow = new AMap.InfoWindow({
                                    content: content,
                                    offset: new AMap.Pixel(0, -30)
                                });
                                
                                // 在鼠标位置打开信息窗体
                                infoWindow.open(map, e.target.getPath()[0]);
                                
                                // 保存信息窗体引用，以便在mouseout时关闭
                                line.infoWindow = infoWindow;
                            });
                            
                            // 添加鼠标移出事件
                            line.on('mouseout', function(e) {
                                if (e.target.infoWindow) {
                                    e.target.infoWindow.close();
                                }
                            });
                            
                            line.setMap(map);
                        });
                    } else {
                        console.error('Invalid connections data:', data);
                    }
                    resolve();
                })
                .catch(error => {
                    console.error('Error in createConnections:', error);
                    reject(error);
                });
            });
        }
    </script>
</body>

</html> 